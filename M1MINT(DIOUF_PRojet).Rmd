---
title: '   [M1MINT] PROJET Machine Learning Exploration non supervisée avec l’algorithmedes
  k-means &  Prédiction avec CART '
author: "Mamadou DIOUF"
date: "14 novembre 2020"
output:
  pdf_document: 
    latex_engine: xelatex
  html_document: 
    toc_depth: 2
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
  ioslides_presentation:
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
##
                                       
**INTRODUCTION**

Les **coyotes**, Canis latrans, les lynx roux(**bobcats**), Lynx rufus, et les renards gris(**gray foxes**), Urocyon cinereoargenteus sont tous des mésoprédateurs mammifères communs dans la Californie côtière et se trouvent en sympatrie dans une grande partie de l'Amérique du Nord. Les excréments produits par ces trois animaux
sont assez similaires, mais ont historiquement été largement différenciées par la morphologie.  
Pour vérifier, l'efficacité de la morphologie classification des excréments en espèces en construisant des modèles prédictifs pour l'identification des espèces avec un ensemble d'excréments bien décrits et vérifiés par l'ADN.**Rachel E. B. Reid** a compilé une base de données de traits morphologiques, biogéochimiques et contextuels pour un ensemble de 122 ADN vérifiés des excréments de bobcat, de coyote et de gray fox: data(scat) dans la librairie caret.

```{r}
library(tree)
library(caret)
library(rpart)
```
##
```{r}
data("scat")
summary(scat)
```
##
```{r}
str(scat)
```
##
|variables |  unités       | Description |    
|:---------|:-------------:|------------:|
|Scat diameter |mm| mesure au point le plus large au 10e de millimètre près|
|Scat length   |cm| longueur de la pièce la plus longue à 0,5 cm près|
|Taper length  |mm |longueur du cône le plus long,le long de l'axe du scat |
|Degree of taper|sans unité| rapport de la longueur du cône au diamètre de l'éclat|
|Number of pieces|integer| nombre d'excréments séparés |
|Scat mass |grams| poids sec total après lyophilisation et cuisson|
|Segmented?|NA| le scat montre-t-il une segmentation? 1 = oui, 0 = non|
|Ropey?  |NA| est-ce que les excréments semblent cordés / tordus / tissés? 1 = oui, 0 = non|
|Flat?   |NA| est-ce que le scat est une flaque d'eau plate qui manque d'autres traits morphologiques? 1 = oui, 0 = non|
|Location |3 point scale| variable catégorielle décrivant l'emplacement des excréments sur le sentier / route - milieu, bord ou hors bord|
|Scrape?  |NA| y a-t-il une éraflure près de la crasse? 1 = oui, 0 = non|  
|d15N |sans unité| delta-N-15 est une mesure du rapport entre les deux isotopes stables de l’azote , ${}^{15}{N}:{}^{14}N$ |  
|d13C |sans unité| delta-C-treize  est une signature isotopique,une mesure du rapport entre les isotopes stables ${}^{13}C:{}^{12}C$ |  
|TI |sans unité| titane 
|C:N Ratio |sans unité|rapport des atomes de carbone aux atomes d'azote dans les excréments, qui est une approximation du degré de carnivore de l'animal |

Nous avons comme variables morphologiques Number, Length, Diameter, Taper, Mass, ropey, segmented, flat et scrape, biogéochimiques d15N, d13C, CN et contextuels Month, Year, Site et Location.  

##
**Exploration non supervisée avec l’algorithme des k-means**


```{r}
pairs(~Number+Length+Diameter+Taper+Mass,main="Simple Scatterplot Matrix",data=scat)

```
##
```{r}
pairs(~TI+d13C+d15N+CN+Length+Mass,main="Simple Scatterplot Matrix",data=scat)
```
Nous constatons des correlations fortes des variables. Surtout entre les variables biogéochimiques.  

##

```{r}
pairs(~Site+Month+Year+Location+Mass+Diameter+Length,main="Simple Scatterplot Matrix",data=scat)
```
##
```{r}
par(mfrow=c(3,3))
hist(scat$Mass, main = "Mass")
hist(scat$Length, main = "Length")
hist(scat$Diameter, main = "Diameter")
hist(scat$Taper, main = "Taper")
hist(scat$Number, main = "Number")
hist(scat$Age, main = "Age")
```
##
```{r}
par(mfrow=c(3,3))
hist(scat$TI, main = "TI")
hist(scat$d13C, main = "Delta-C-treize")
hist(scat$d15N, main = "Delta-N-quinze")
hist(scat$CN, main = "Carbone:Azote")
hist(scat$ropey, main = "Ropey")
hist(scat$segmented, main = "Segmented")

```

##
```{r}
par(mfrow=c(3,2))
boxplot(Mass~Species,data=scat)
boxplot(Length~Species,data=scat)
boxplot(Diameter~Species,data=scat)
boxplot(Number~Species,data=scat)
boxplot(Taper~Species,data=scat)

```
Les médianes de Mass et Diameter de grayfox sont plus bas que celles des autres.  
Les médianes de longueur sont sensiblement égales pour toutes les espèces.  
Les bobcat ont une médiane plus grand par rapport aux coyotes et gray_fox. 

##
```{r}
par(mfrow=c(2,2))
boxplot(CN~Species,data=scat)
boxplot(d13C~Species,data=scat)
boxplot(d15N~Species,data=scat)
boxplot(TI~Species,data=scat)

```
Les médianes de d15N et d13C pour coyote supérieure à celle des autres qui ont des médianes très proches.  
La médiane de CN pour les gray_fox est supérieure à celle des autres.  
##
```{r}
te=scat
te$Location=as.numeric(scat$Location)
te$Site=as.numeric(scat$Site)
par(mfrow=c(2,2))

boxplot(Location~Species,data=te)
boxplot(ropey~Species,data=scat)
boxplot(segmented~Species,data=scat)
boxplot(flat~Species,data=scat)


```
La médiane d'excréments segmentés est très élevée pour bobcat par rapport aux autres tandis que celle de gray_fox est nulle.  
##

```{r}
par(mfrow=c(2,2))
hist(as.numeric(scat$Site))
boxplot(scrape~Species,data=scat)
boxplot(Site~Species,data=te)
boxplot(Age~Species,data=te)

```

##
```{r}
rowna=sum(rowSums(is.na(scat))!=0)
colna=sum(colSums(is.na(scat))!=0)
print(paste('Le nombre de lignes contenant de NA est: ',rowna),quote = FALSE)
print(paste('Le nombre de colonnes contenant de NA est: ',colna),quote = FALSE)
```
Comme nous avons des données manquantes, alors pour la méthode des kmeans nous pouvons soit supprimer les individus avec des données manquantes, soit remplacer le NA par la moyenne de la colonne où elle se trouve.  
Cependant la méthode des kmeans est utilisée que pour variable quantitative  

##
**kmeans avec données manquantes supprimées**

```{r scat sans NA}
scat.nona=data.frame(na.omit(scat))   #supprime les NAs
```

##
```{r }
scat.scale = scale(scat.nona[,c(3,6:15)]) #centrage des valeurs quantitatives
km=kmeans(scat.scale,3)
plot(scat.nona[,7:11], col = km$cluster)  #visualisation sur les variables 7 à 11
points(km$centers, col = 1:3, pch = 8)
```
Nous constatons trois groupes: l'un d'eux est inclus dans l'union des deux autres qui une intersection petite.  

```{r k=4}
km=kmeans(scat.scale,4)
plot(scat.nona[,7:11], col = km$cluster)  #visualisation sur les variables 7 à 11
points(km$centers, col = 1:4, pch = 8)
```


```{r}
library(factoextra)
library(NbClust)
```
##
```{r}
fviz_nbclust(scat.scale, kmeans, method = "wss") +
    geom_vline(xintercept = 4, linetype = 2)+
  labs(subtitle = "Elbow method")
```

##
La valeur optimale de $k$ pour est $4$ pour des $k$ entre $0$ et $10$.
  
**kmeans avec données manquantes remplacer par la moyenne**

```{r scat.moy Na par mean}
scat.moy = data.frame(scat)
for (j in c(3,6:15)) #variable quantitatives
{colm=mean(scat.nona[,j])
  for ( i in 1:110)
  {
    if (is.na(scat.moy[i,j]))
      {
      scat.moy[i,j]=colm
      
      }
  }
}
```

```{r}
summary(scat.moy)

```
Nous voyons bien que les Nas sont remplacées.  
##
```{r }
scat.scale1 = scale(scat.moy[,c(3,6:15)]) #centrage des valeurs quantitatives
km3=kmeans(scat.scale1,3)
plot(scat.moy[,7:11], col = km3$cluster)  #visualisation sur les variables 7 à 11
points(km3$centers, col = 1:3, pch = 8)
```
##
```{r}
fviz_nbclust(scat.scale1, kmeans, method = "wss") +
    geom_vline(xintercept = 4, linetype = 2)+
  labs(subtitle = "Elbow method")
```

Nous ne constatons pas de différence visible et nous avons le même optimal $k = 4$.  
  

##
**Prédiction avec CART (Arbre de decision)**
 
```{r}
library(rpart.plot)
```

```{r }
p <- createDataPartition(y=scat$Species,p=60/100,list=FALSE) # 60% entrainement
train <- scat[p,]   #Jeu d'entrainement
test <-  scat[-p,]   #Jeu de test

model <- rpart(Species~. , data = train, control = rpart.control(minsplit = 1,cp=0))

prp(model, extra = 1, cex = 0.5)

pred <- predict(model,test,type = "class")

confM<-confusionMatrix(pred,test$Species)
confM
```
##
```{r}
print(paste("L'erreur de prédiction est estimée à:",  1 - confM$overall[1]),quote = FALSE)

```
##
```{r }
p <- createDataPartition(y=scat$Species,p=80/100,list=FALSE) # 80% entrainement
train <- scat[p,]   #Jeu d'entrainement
test <-  scat[-p,]   #Jeu de test

model <- rpart(Species~. , data = train, control = rpart.control(minsplit = 1,cp=0))

prp(model, extra = 1, cex = 0.5)

pred <- predict(model,test,type = "class")

confM1<-confusionMatrix(pred,test$Species)
confM1

```
##
```{r}
print(paste("L'erreur de prédiction pour 20% test est estimée de  à:",  1 - confM1$overall[1]),quote = FALSE)

```
##
```{r }
p <- createDataPartition(y=scat$Species,p=40/100,list=FALSE) # 40% entrainement
train <- scat[p,]   #Jeu d'entrainement
test <-  scat[-p,]   #Jeu de test

model <- rpart(Species~. , data = train, control = rpart.control(minsplit = 1,cp=0))

prp(model, extra = 1, cex = 0.5)

pred <- predict(model,test,type = "class")

confM2<-confusionMatrix(pred,test$Species)
confM2

```
#
```{r}
for (pr in seq(0.01,1,0.15))
{ p <- createDataPartition(y=scat$Species,p=pr,list=FALSE) 
  train <- scat[p,]   #Jeu d'entrainement
  test <-  scat[-p,]   #Jeu de test
  
  model <- rpart(Species~. , data = train, control = rpart.control(minsplit = 1,cp=0))
  pred <- predict(model,test,type = "class")
  
  confM3<-confusionMatrix(pred,test$Species)
  print(paste("L'erreur de prédiction est estimée à:",  1 - confM3$overall[1],"avec", pr*100,"% comme train"),quote = FALSE)
  }
```

Nous pouvons conclure que la précision n'est pas du pourcentage du jeu d'entrainement.


